<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <meta charset="UTF-8">
    <title>BOBIK</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
</head>
<style>
    .json-render {
    font-family: monospace;
    padding: 10px;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 4px;
}

@supports (-webkit-touch-callout: none) {
    body {
        font-size: 35px;
    }

    #arm-status-light {
        width: 200px !important;
    }

    text {
        transform: scaleY(4) !important;
        transform-origin: 0 0 !important;
    }

    select {
        scale: 150%;
    }
}

@supports not (-webkit-touch-callout: none) {
  
}

.json-key {
    color: blue;
}

.json-string {
    color: green;
}

.json-number {
    color: red;
}

.json-boolean, .json-null {
    color: purple;
}

.item-even {
    background-color: #ffffcc;
}

.item-odd {
    background-color: #ffffff;
}

.blue {
    color: white !important;
    background-color: blue !important;
}

.red {
    color: white !important;
    background-color: red !important;
}

.bluebg {
    background-color: rgba(100, 87, 255, 0.52) !important;
}

.redbg {
    background-color: rgba(255, 87, 87, 0.52) !important;
}

.green {
    color: white !important;
    background-color: green !important ;
}

.gray {
    color: black !important;
    background-color: lightgray !important;
}

#title-image {
    padding: 20px;
}

.angry-dog {
    content: url("dog.jpg") !important;
}

hr {
    height: 0px;
    border: none;
}

select {
    scale: 150%;
}

#right-button-spacer {
    height: 20px;
}

.vertical-button-holder {
    height: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
}


#arm-status-controls-holder {
    width: 150px;
    height: 150px;
    padding: 20px;
    margin: 0px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
}

#alarm-status-light {
    background-color: white;
    width: 75%;
    height: 200px;
    border: 0px solid red;
    border-radius: 10px;
    -moz-border-radius: 25px;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
}

#arm-status-light {
    background-color: white;
    margin: 10px;
    width: 150px;
    height: 150px;
    padding: 0px;
    border: 0px solid red;
    border-radius: 25px;
    -moz-border-radius: 25px;
    align-items: center;
    justify-content: space-around;
    display: flex;

}

button {
    border-radius: 8px;
    height: 120px;
    width: 180px;
    transition-duration: .4s;
    font-size: inherit;
}

button:hover {
    color: black;
    font-weight: bold;
    box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24), 0 17px 50px 0 rgba(0,0,0,0.19);
}

.blinkingTransitions {
    animation-name: blink;
    animation-duration: .2s;
    animation-iteration-count: infinite;
    animation-direction: alternate;
    animation-timing-function: linear;
}

nav {
    background-color: rgba(0, 0, 0, 0.53);
    margin-bottom: 20px;
    margin-top: 20px;
    justify-content: space-around;
    align-items: center;
    display: flex;
    flex-direction: row;
}

div {
    white-space: pre;
}

@keyframes blink {
    from {background-color: red;}
    to {background-color: blue;}
    from {color: white}
    to {color: white}
}

.container {
    display: flex;
    flex-direction: column;
}

.column {
    display: flex;
    align-items: center;
    margin-right: 10px;
}

.title {
    font-weight: bold;
    margin-right: 10px;
}
</style>
<body>    
    <script type="text/javascript">
        var socket = io.connect('http://bobik:8080');
        let strOldStatusData = "";
        let strOldProfilesData = "";
        let intProfileNumber = 0;

        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('postStatus', function(data) {
            //console.log('Message from server:', data.message);
            if (strOldStatusData == JSON.stringify(data.message))
                return;
            else {
                renderMessage(data.message, 'statusContainer');
                updateProfilesDropdownSelection(data.message);
                strOldStatusData = JSON.stringify(data.message);
            }
            
            blinkAlarmStatus(data.message.alarmStatus === "ALARM");
        });

        socket.on('postAlarmProfiles', function(data) {
            //console.log('Message from server:', data.message);
            if (!(data && data.message && data.message.profiles)) {
                return;
            }
            if (strOldProfilesData == JSON.stringify(data.message))
                return;
            else {
                renderMessage(data.message, 'profilesContainer');
                renderProfilesDropdown(data.message.profiles)
                strOldProfilesData = JSON.stringify(data.message)    
            }
        });

        function paintArmStatus(isArmed) {
            let divs = document.getElementsByClassName('class-armStatus');
            if (!divs.length) return;
            let armStatusJsonRow = divs[0].parentElement;
            let armButton = document.getElementById('button-arm');
            let disarmButton = document.getElementById('button-disarm');
            let armStatusDiv = document.getElementById('arm-status-light');
            let titleImage = document.getElementById('title-image');
            let body = document.body;

            armStatusDiv.classList.remove(!isArmed ? "blue" : "red")
            armStatusDiv.classList.add(isArmed ? "blue" : "red")
            armStatusDiv.innerText = (isArmed ? "ARMED" : "DISARMED") //direct DOM ACCESS

            armStatusJsonRow.classList.remove(!isArmed ? "blue" : "red")
            armStatusJsonRow.classList.add(isArmed ? "blue" : "red")

            body.classList.remove(!isArmed ? "bluebg" : "redbg")
            body.classList.add(isArmed ? "bluebg" : "redbg")

            armButton.classList.remove(!isArmed ? "gray" : "blue");
            armButton.classList.add(isArmed ? "gray" : "blue");

            disarmButton.classList.remove(!isArmed ? "red" : "gray");
            disarmButton.classList.add(isArmed ? "red" : "gray");

            if (isArmed) {
                titleImage.classList.add("angry-dog");
            } else {
                titleImage.classList.remove("angry-dog");
            }
        }

        function blinkAlarmStatus(blink) {
            let divs = document.getElementsByClassName('class-alarmStatus');
            if (!divs.length) return;
            let parent = divs[0].parentElement;
            parent.classList.remove(!blink ? 'blinkingTransitions' : 'green')
            parent.classList.add(blink ? 'blinkingTransitions' : 'green')
            let alarmStatusDiv = document.getElementById('alarm-status-light');
            alarmStatusDiv.classList.remove(!blink ? 'blinkingTransitions' : 'green')
            alarmStatusDiv.classList.add(blink ? 'blinkingTransitions' : 'green')
        }

        function sendMessage() {
            socket.emit('getStatus', { message: undefined });
        }

        function arm() {
            socket.emit('arm', {message: undefined});
        }

        function disarm() {
            socket.emit('disarm', {message: undefined});
        }

        function setAlarmProfile() {
            let selectedIndex = document.getElementById("profiles-dropdown").selectedIndex;
            intProfileNumber = selectedIndex;
            socket.emit('setAlarmProfile', {message: selectedIndex});
        } 

        setInterval(sendMessage, 1000);
        setTimeout(() => {socket.emit('getAlarmProfiles', { message: undefined });}, 500);
        
        function updateProfilesDropdownSelection(newStatusData) {
            let oldProfileNumber = intProfileNumber; //global
            let newProfileNumber = Number(newStatusData.profileNumber);
            if (oldProfileNumber !== newProfileNumber && document.getElementById('profiles-dropdown').selectedIndex !== newProfileNumber) {
                document.getElementById('profiles-dropdown').selectedIndex = newProfileNumber;
                intProfileNumber = newProfileNumber;
            }
        }

        function renderProfilesDropdown(arrProfiles) {
            var container = document.getElementById("profiles-dropdown-container");
            let dropdown;
            
            if (!container.hasChildNodes()) {
                dropdown = document.createElement('select');
                dropdown.setAttribute('id', 'profiles-dropdown');
                dropdown.addEventListener('change', setAlarmProfile);
            } else {
                dropdown = document.getElementById('profiles-dropdown');
            }

            while (dropdown.hasChildNodes()) {
                dropdown.removeChild(dropdown.lastChild);
            }

            arrProfiles.forEach((profile, index) => {
                const option = document.createElement('option');
                option.value = profile.index+1;
                option.text = profile.name;
                dropdown.appendChild(option);
            });

            container.appendChild(dropdown);


            // Append the select element to the container
            if (!container.hasChildNodes()) {
                container.appendChild(dropdown);
            }
        }

        function renderMessage(message, containerName) {
            var node = document.getElementById(containerName);
            while (node.hasChildNodes()) {
                node.removeChild(node.lastChild);
            }

            let excludedFields = {"memberDevices": true, "profileNumber": true}

            var container = document.getElementById(containerName);
            let counter = 0;

            for (var key in message) {
                if (key in excludedFields)
                    continue;

                var column = document.createElement('div');
                column.classList.add('column');
                column.classList.add(counter%2 > 0 ? 'item-odd' : 'item-even');

                var title = document.createElement('div');
                title.classList.add('title');
                title.classList.add('class-' + key)
                title.textContent = key + ':';

                var value = document.createElement('div');
                value.id = 'div-' + key;
                value.classList.add('class-' + key);
                value.innerHTML = getJSONtext(message[key]); //DIRECT DOM ACCESS

                column.appendChild(title);
                column.appendChild(value);

                container.appendChild(column);

                if (key === 'armStatus') {
                    paintArmStatus(message[key] == 'ARMED')
                }
                counter++;
            }
        }

        function getJSONtext(jsonValue) {

            if (typeof jsonValue === 'object') {
                jsonValue = JSON.stringify(jsonValue, null, 2);
            } else {
                return jsonValue;
            }

            return syntaxHighlight(jsonValue);
        }

        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(
                /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g,
                function(match) {
                    var cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                }
            );
        }
    </script>
    <nav>
        <span id="span-title">
            <img id="title-image" src="dogue.jpg" width="130px" height="170px" />
        </span>
        <div id="alarm-status-light">
            <div id="vertical-button-holder-left" class="vertical-button-holder">
                <button id="button-arm" onclick="arm()">ARM</button>
                <div id="profiles-dropdown-container"></div>
            </div>
            <div id="vertical-button-holder-right" class="vertical-button-holder">
                <button id="button-disarm" onclick="disarm()">DISARM</button>
                <div id="right-button-spacer"></div>
            </div>
        </div>
        <div id="arm-status-controls-holder">
            <div id="arm-status-light"></div>
            
        </div>
    </nav>
    <div class="container" id="statusContainer"></div>
    <div class="container" id="profilesContainer"></div>
</body>
</html>
